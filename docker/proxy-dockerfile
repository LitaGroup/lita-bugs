# 下载源码镜像
FROM bitnami/git as cat2bug_git_src
#切换目录，指定源码克隆后保存位置
WORKDIR /usr/local/code
ADD http://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp /tmp/bustcache
# 拉取源代码
# 如果私有仓卡记得加账号密码
RUN git clone https://yuzhantao%40qq.com:123a123b@e.coding.net/qyzw/cat2bug/cat2bug-proxy.git

# 创建证书
FROM soulteary/certs-maker as cat2bug_certs
ENV CERT_DNS=default,127.0.0.1,localhost
ENV CERT_CN=Cat2Bug-Site
ENV CERT_O=QY
RUN ["certs-maker"]

FROM node:latest
MAINTAINER yuzhantao
WORKDIR /cat2bug
COPY --from=cat2bug_git_src /usr/local/code .
WORKDIR /cat2bug/cat2bug-proxy
COPY --from=cat2bug_certs /ssl ./ssl
RUN --mount=type=cache,target=/cat2bug/cat2bug-proxy/node_modules,id=app_node_modules,sharing=locked --mount=type=cache,target=/root/.npm,id=npm_cache npm install --registry http://registry.npm.taobao.org
CMD [ "node", "proxy.js" ]
