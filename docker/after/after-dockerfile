# 下载源码镜像
FROM bitnami/git as cat2bug_git_src
#切换目录，指定源码克隆后保存位置
WORKDIR /usr/local/code
ADD http://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp /tmp/bustcache
# 拉取源代码
# 如果私有仓卡记得加账号密码
RUN git clone https://yuzhantao%40qq.com:123a123b@e.coding.net/qyzw/cat2bug/cat2bug-platform.git

FROM maven:3.8.5-openjdk-11 as cat2bug_java_build
#切换目录，指定编译源码位置
WORKDIR /usr/local/code
#将源码复制到下一个镜像中
COPY --from=cat2bug_git_src /usr/local/code .
WORKDIR /usr/local/code/cat2bug-platform
RUN --mount=type=cache,target=/root/.m2 mvn clean install
RUN mvn clean install

# 执行
FROM  openjdk:11-jre
# author
MAINTAINER yuzhantao@qq.com
# 创建目录
RUN mkdir -p /home
# 指定路径
WORKDIR /home
#将源码复制到下一个镜像中
COPY --from=cat2bug_java_build /usr/local/code/cat2bug-platform/cat2bug-platform-admin/target/cat2bug-admin.jar .
# 启动认证服务
ENTRYPOINT ["nohup", "java","-jar","cat2bug-admin.jar","&"]